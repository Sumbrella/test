Subroutine GzComputBCE()



INCLUDE 'FFTW3.F'
!------------------------------------------------------------------------
    
!------------------------------------------------------------------------
INTEGER(KIND=8)::FWD,BWD,STATUS

!----------Auxiliary Variable----------!

Integer(kind=4):: IX,IY,IZ
 
Real(kind=8):: Z1,Z2,Z1SQ,Z2SQ,CS1

real(kind=8):: Para

!------------------------------------------------------------------------
REAL(KIND=8)::R1(NX+1,NY+1),R2(NX+1,NY+1)

REAL(KIND=8)::ARG1ZZ(NX+1,NY+1),ARG2ZZ(NX+1,NY+1) 

REAL(KIND=8)::ARG1XY(NX+1,NY+1),ARG2XY(NX+1,NY+1),ARG1YX(NX+1,NY+1),ARG2YX(NX+1,NY+1)

!------------------------------------------------------------------------ 

COMPLEX(KIND=8)::FEXT(2*NX,2*NY),CEXT(2*NX,2*NY),GEXT(2*NX,2*NY)

!------------------------------------------------------------------------ 

 allocate(Gz(NX,NY))

Gz(:,:) = 0.

!------------------------------------------------------------------------
! Start Weight Coefficient Computation
!------------------------------------------------------------------------

xc(:) = 0.

yc(:) = 0.

xcsq(:) = 0.

ycsq(:) = 0.

rsq(:,:) = 0.

xy(:,:) = 0.


!------------------------------------------------------------------------

!------------------------------------------------------------------------
DO IX=1,NY+1
       !-----------------------------------------------------------------
       YC(IX)=(IX-1.5)*DY
       
       YCSQ(IX)=YC(IX)**2
       !-----------------------------------------------------------------
ENDDO
!------------------------------------------------------------------------


!------------------------------------------------------------------------
DO IX=1,NX+1
       !-----------------------------------------------------------------
       XC(IX)=(IX-1.5)*DX
       
       XCSQ(IX)=XC(IX)**2
       !-----------------------------------------------------------------       
       DO IY=1,NY+1
              !----------------------------------------------------------
              RSQ(IX,IY)=XCSQ(IX)+YCSQ(IY)
              
              XY(IX,IY)=XC(IX)*YC(IY)
              !----------------------------------------------------------
       ENDDO
       !-----------------------------------------------------------------          
ENDDO
!------------------------------------------------------------------------


CS1=SI2MG*GAMMA

GEXT(:,:)=0.

                        
!------------------------------------------------------------------------
DO IZ =1,NZ
        !----------------------------------------------------------------  
        Z1=(Z0-Z(IZ+1))
        
        Z2=(Z0-Z(IZ))    
          
        Z1SQ=Z1*Z1
        
        Z2SQ=Z2*Z2
        !----------------------------------------------------------------
        DO IX=1,NX+1
               !---------------------------------------------------------
               DO IY=1,NY+1
                      !--------------------------------------------------                                      
                      R1(IX,IY)=SQRT(RSQ(IX,IY)+Z1SQ)
        
                      R2(IX,IY)=SQRT(RSQ(IX,IY)+Z2SQ)
                      

                      
                      ARG1XY(IX,IY)=YC(IY)*LOG(XC(IX)+R1(IX,IY)) 
                      
                      ARG2XY(IX,IY)=YC(IY)*LOG(XC(IX)+R2(IX,IY))  
                      
                      
                      ARG1YX(IX,IY)=XC(IX)*LOG(YC(IY)+R1(IX,IY)) 
                      
                      ARG2YX(IX,IY)=XC(IX)*LOG(YC(IY)+R2(IX,IY))                                      
                      
   
                      
                      ARG1ZZ(IX,IY)=Z1*ATAN2(Z1*R1(IX,IY),XY(IX,IY)) 
                      
                      ARG2ZZ(IX,IY)=Z2*ATAN2(Z2*R2(IX,IY),XY(IX,IY)) 
                      !--------------------------------------------------        
               ENDDO
               !---------------------------------------------------------        
        ENDDO
        !----------------------------------------------------------------  
        
        CEXT(:,:)=0.
        
        FEXT(:,:)=0.
        
        !----------------------------------------------------------------
        DO IX=1,NX
               !---------------------------------------------------------
               DO IY=1,NY
                      !-------------------------------------------------- 
                      CEXT(IX,IY)=CS1*((arg2xy(ix+1,iy+1)+arg2yx(ix+1,iy+1)+arg2zz(ix+1,iy+1))+&
                                    & (arg1xy(ix,iy+1)+arg1yx(ix,iy+1)+arg1zz(ix,iy+1)) +&
                                    & (arg1xy(ix+1,iy)+arg1yx(ix+1,iy)+arg1zz(ix+1,iy)) +&
                                    & (arg2xy(ix,iy)+arg2yx(ix,iy)+arg2zz(ix,iy))       -&
                                    & (arg1xy(ix+1,iy+1)+arg1yx(ix+1,iy+1)+arg1zz(ix+1,iy+1)) -&
                                    & (arg2xy(ix,iy+1)+arg2yx(ix,iy+1)+arg2zz(ix,iy+1)) -&
                                    & (arg2xy(ix+1,iy)+arg2yx(ix+1,iy)+arg2zz(ix+1,iy))-&
                                    & (arg1xy(ix,iy)+arg1yx(ix,iy)+arg1zz(ix,iy)))
                      
                      FEXT(IX,IY)=RHO(IX,IY,IZ)
                      !--------------------------------------------------                              
               ENDDO
               !---------------------------------------------------------        
        ENDDO       
        !---------------------------------------------------------------- 
                
        !---------------------------------------------------------------- 
        DO IX=NX+2,2*NX
               !---------------------------------------------------------
               CEXT(IX,:)=CEXT(2*NX-IX+2,:)
               !---------------------------------------------------------
        ENDDO
        !---------------------------------------------------------------- 
        
        !---------------------------------------------------------------- 
        DO IY=NY+2,2*NY
               !---------------------------------------------------------
               CEXT(:,IY)=CEXT(:,2*NY-IY+2)
               !---------------------------------------------------------
        ENDDO        
        !---------------------------------------------------------------- 
        
!------------------------------------------------------------------------
! End Weight Coefficient Computation
!------------------------------------------------------------------------        
        
        
!------------------------------------------------------------------------
! Start BCE Algorithm
!------------------------------------------------------------------------        
        FWD=0
        
        STATUS=0
        !----------------------------------------------------------------         
        
        
        !----------------------------------------------------------------  
        CALL dfftw_plan_dft_2d(fwd, 2*Nx, 2*Ny, fext, fext, FFTW_FORWARD, FFTW_ESTIMATE)
        
        CALL DFFTW_EXECUTE(FWD)
        
        CALL DFFTW_DESTROY_PLAN(FWD)
        !---------------------------------------------------------------- 
        FWD=0
        
        STATUS=0
        !----------------------------------------------------------------          
        CALL dfftw_plan_dft_2d(fwd, 2*Nx, 2*Ny, cext, cext, FFTW_FORWARD, FFTW_ESTIMATE)
        
        CALL DFFTW_EXECUTE(FWD)
        
        CALL dfftw_destroy_plan(FWD)
        !----------------------------------------------------------------          
        
        !----------------------------------------------------------------         
        DO IX=1,2*NX
               !--------------------------------------------------------
               DO IY=1,2*NY
                      !-------------------------------------------------
                      GEXT(IX,IY)=GEXT(IX,IY)+FEXT(IX,IY)*CEXT(IX,IY)
                      !-------------------------------------------------
               ENDDO
               !--------------------------------------------------------
        ENDDO       
        !---------------------------------------------------------------- 
        
            
ENDDO
!------------------------------------------------------------------------ 




        !---------------------------------------------------------------- 
        BWD=0
        
        STATUS=0
        !----------------------------------------------------------------         
        CALL dfftw_plan_dft_2d(bwd, 2*Nx, 2*Ny, gext, gext, FFTW_BACKWARD, FFTW_ESTIMATE)
        
        CALL dfftw_execute_dft(bwd, gext, gext) 
        
        CALL DFFTW_DESTROY_PLAN(BWD)
        !----------------------------------------------------------------    
        
        !----------------------------------------------------------------          
                
        Para = 2.*NX*2.*NY
        
        !----------------------------------------------------------------         
        DO IX=1,NX
               !--------------------------------------------------------
               DO IY=1,NY
                      !-------------------------------------------------
                      GZ(IX,IY)=real(GEXT(IX,IY)/Para)
                      !-------------------------------------------------
               ENDDO
               !--------------------------------------------------------
        ENDDO       
        !----------------------------------------------------------------         
       
!------------------------------------------------------------------------
! End BCE Algorithm
!------------------------------------------------------------------------   

!------------------------------------------------------------------------
        
                                        RETURN

END
!------------------------------------------------------------------------